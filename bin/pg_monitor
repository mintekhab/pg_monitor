#!/usr/bin/python

import pg_monitor
import argparse
import sys


def runMonitor() :
        parse = argparse.ArgumentParser(prog='pg_monitor' ,description = 'Checks for a PostgreSQL server')
        parse.add_argument ('--port' , type=str , default=5432 , nargs='?', help='Port of the database to be accessed. Default:  %(default)s')
        parse.add_argument ( '--user' , type=str , default='postgres', help='Username allowed to access the database. Default:  %(default)s')
        parse.add_argument ('--password', type=str , default='' , help='Password of the supplied user. Default:  %(default)s' )
        parse.add_argument ( '--dbname', type=str , default='postgres', help='The name of the database to be accessed. Default:  %(default)s'  )
        parse.add_argument ( '--host', type=str , default='localhost', nargs='?' ,help='Host of the database. Default:  %(default)s' )
        parse.add_argument ( '--check', type=str, required=True, choices=['backends','connections','wals','vacuum','autovacuum','analyze','autoanalyze',\
                             'table_bloat','index_bloat','blocking','nonblocking','table_size','index_size','database_size','checkpoints',\
                              'duplicate_indexes','replica_lag'], help='' )
        parse.add_argument ('--find' , type=str , nargs='?',default='', help = 'Finding partterns in locks')
	parse.add_argument ('--exclude_db' , type=str , nargs='?',default=None , help = 'Exclude database not to be queried')
	parse.add_argument ('--exclude_pattern' , type=str , nargs='?',default='', help = 'Exclude patterns not to be searched for')
        parse.add_argument ( '--warning', type=str, default =None, help='Values to be considered as warning signs ' )
        parse.add_argument ( '--critical', type=str , default=None ,help='Values for the critical checks')
        # assign all arguments to an array
        args = parse.parse_args()
        # Get the individual arguments
        param = {}
	host = str( args.host ).split(',')
	port = str( args.port ).split(',')
	if len (host) != len(port) :
		print ('Miss-match array size of the host and port was specified. Please correct this and try again')
		sys.exit(0)

        param['host'] = host
        param['port'] = port
        param['user'] = args.user
        param['password'] = args.password
        param['dbname'] = args.dbname
        param['check'] = args.check
        param['find'] = str( args.find ).split(',')
	param['warning'] = args.warning
	param['critical'] = args.critical
	param['exclude_db'] = str ( args.exclude_db ).split(',')
	param['exclude_pattern'] = str ( args.exclude_pattern ).split(',')


	pg_monitor.getArgs(param)


if __name__ == '__main__' :
        runMonitor()

